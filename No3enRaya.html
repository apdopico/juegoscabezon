<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>No3enRaya</title>
  <link rel="icon" type="image/png" href="https://apdopico.github.io/juegoscabezon/Imagenes/faviconCabeza.png?v=3">
  <style>
    body {
      background-color: #3d5c5c;
      background-image: url("../Imagenes/imagenFondo.png");
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding-top: 40px;
      color: #fff;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      margin: 0 auto;
      background-color: antiquewhite;
      width: 90vw;
      max-width: 420px;
      aspect-ratio: 1 / 1;
      border: 2px solid #333;
      gap: 6px;
      padding: 6px;
      box-sizing: border-box;
    }

    .cell {
      width: 100%;
      height: 100%;
      font-size: min(5vw, 28px);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #444;
      cursor: pointer;
      user-select: none;
      background-color: #fdfdfd;
      position: relative;
      outline: none;
    }

    .cell[aria-disabled="true"] {
      cursor: default;
      opacity: 0.9;
    }

    .piece {
      width: 70%;
      height: 70%;
      border-radius: 50%;
    }

    .p1 { background: #ff6b6b; }
    .p2 { background: #4d96ff; }

    .score {
      margin-top: 18px;
      font-size: 18px;
      display: flex;
      justify-content: center;
    }

    .score table {
      border-collapse: collapse;
      background-color: antiquewhite;
      overflow: hidden;
      color: #111;
    }

    .score td {
      padding: 6px 12px;
      border: 1px solid #444;
      text-align: center;
      height: 36px;
      vertical-align: middle;
    }

    .cell-nombre {
      position: relative;
      text-align: left;
      padding-left: 10px;
      height: 1.8em;
      overflow: hidden;
    }

    .crown {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -55%) scale(0.7);
      font-size: 1.4em;
      opacity: 0;
      transition: opacity 0.4s ease, transform 0.4s ease;
      pointer-events: none;
      z-index: 2;
    }

    .crown.visible {
      opacity: 1;
      transform: translate(-50%, -55%) scale(1);
    }

    .reiniciar-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      height: 100%;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: transform 0.2s ease;
    }

    .reiniciar-btn:hover { transform: scale(1.06); }

    .reiniciar-btn img { width: 25px; height: 25px; object-fit: contain; }

    #status {
      padding: 6px;
      font-weight: 700;
    }
  </style>
</head>
<body>
  
  <div id="board" class="board" aria-label="Tablero 4x4"></div>

  <div class="score">
    <table role="table" aria-label="Marcador">
      <tr>
        <td colspan="2" id="status" role="cell">Turno: M치quina</td>
      </tr>
      <tr id="rowJugador">
        <td class="cell-nombre" role="cell">
          <span id="crownJugador" class="crown" aria-hidden="true"></span>
          Jugador
        </td>
        <td role="cell"><span id="jugadorRest">8</span> fichas</td>
      </tr>
      <tr>
        <td class="cell-nombre" role="cell">
          <span id="crownIA" class="crown" aria-hidden="true"></span>
          M치quina
        </td>
        <td role="cell"><span id="iaRest">8</span> fichas</td>
      </tr>
      <tr>
        <td colspan="2" role="cell">
          <button id="resetBtn" class="reiniciar-btn" aria-label="Reiniciar partida">
            <img src="https://apdopico.github.io/juegoscabezon/Imagenes/reiniciar2.png" alt="Reiniciar">
          </button>
        </td>
      </tr>
    </table>
  </div>

<script>
    (function(){
      const boardEl = document.getElementById('board');
      const statusEl = document.getElementById('status');
      const jugadorRest = document.getElementById('jugadorRest');
      const iaRest = document.getElementById('iaRest');
      const crownJugador = document.getElementById('crownJugador');
      const crownIA = document.getElementById('crownIA');
      const resetBtn = document.getElementById('resetBtn');

      const AI = 2, HUMAN = 1;
      const SIZE = 4;

      // 游댠 Primera partida empieza M치quina
      let nextStartingPlayer = 2;

      function generateWins(){
        const wins = [];
        const size=SIZE;
        for(let r=0;r<size;r++){
          for(let c=0;c<=size-3;c++)
            wins.push([r*size+c, r*size+c+1, r*size+c+2]);
        }
        for(let c=0;c<size;c++){
          for(let r=0;r<=size-3;r++)
            wins.push([r*size+c, (r+1)*size+c, (r+2)*size+c]);
        }
        for(let r=0;r<=size-3;r++){
          for(let c=0;c<=size-3;c++)
            wins.push([r*size+c, (r+1)*size+(c+1), (r+2)*size+(c+2)]);
        }
        for(let r=0;r<=size-3;r++){
          for(let c=2;c<size;c++)
            wins.push([r*size+c, (r+1)*size+(c-1), (r+2)*size+(c-2)]);
        }
        return wins;
      }

      const WINS = generateWins();
      let board, remaining, currentPlayer, gameOver;

      function init(){
        board = Array(SIZE*SIZE).fill(null);
        remaining = {1:8,2:8};

        // 游댠 Alternancia real entre partidas
        currentPlayer = nextStartingPlayer;

        // Preparar pr칩xima partida
        nextStartingPlayer = (nextStartingPlayer === 1 ? 2 : 1);

        gameOver = false;
        render();
        updateStatus();
        updatePieces();
        clearCrowns();

        if(currentPlayer === AI) setTimeout(()=>aiMove(), 500);
      }

      function render(){
        boardEl.innerHTML='';
        for(let i=0;i<SIZE*SIZE;i++){
          const cell=document.createElement('div');
          cell.className='cell';
          cell.setAttribute('data-pos', i);
          cell.setAttribute('role','button');
          if(board[i]!==null){
            const p=document.createElement('div');
            p.className='piece '+(board[i]===1?'p1':'p2');
            p.setAttribute('aria-hidden','true');
            cell.appendChild(p);
            cell.setAttribute('aria-disabled','true');
            cell.tabIndex = -1;
          } else {
            cell.setAttribute('aria-disabled','false');
            cell.tabIndex = 0;
            cell.addEventListener('click', onCellClickBound);
            cell.addEventListener('keydown', e=>{
              if((e.key === 'Enter' || e.key === ' ') && !gameOver && currentPlayer===HUMAN){
                e.preventDefault();
                onCellClickBound.call(e.currentTarget, e);
              }
            });
          }
          boardEl.appendChild(cell);
        }
      }

      function onCellClickBound(e){
        const pos = Number(this.dataset.pos);
        if(gameOver || currentPlayer!==HUMAN) return;
        if(board[pos]!==null || remaining[HUMAN]<=0) return;
        placePiece(pos,HUMAN);
        if(!gameOver) setTimeout(()=>aiMove(),400);
      }

      function placePiece(pos,player){
        board[pos]=player;
        remaining[player]--;
        render();
        updatePieces();

        if(checkThree(player)){
          gameOver=true;
          showCrown(player===HUMAN ? AI : HUMAN);
          return;
        }
        if(board.every(x=>x!==null) || (remaining[1]===0 && remaining[2]===0)){
          gameOver=true;
          showCrown('empate');
          return;
        }

        currentPlayer = (player===HUMAN ? AI : HUMAN);
        updateStatus();
      }

      function checkThree(player,state=board){
        return WINS.some(line=>line.every(i=>state[i]===player));
      }

      function updateStatus(){
        statusEl.textContent =
          gameOver ? 'Partida finalizada' :
          `Turno: ${currentPlayer===HUMAN ? 'Jugador' : 'M치quina'}`;
      }

      function updatePieces(){
        jugadorRest.textContent = remaining[HUMAN];
        iaRest.textContent = remaining[AI];
      }

      function clearCrowns(){
        [crownJugador, crownIA].forEach(c=>{
          c.textContent='';
          c.classList.remove('visible');
        });
      }

      function showCrown(winner){
        clearCrowns();
        if(winner==='empate'){
          crownJugador.textContent='游녬';
          crownIA.textContent='游녬';
          crownJugador.classList.add('visible');
          crownIA.classList.add('visible');
        } else if(winner===HUMAN){
          crownJugador.textContent='游녬';
          crownJugador.classList.add('visible');
        } else if(winner===AI){
          crownIA.textContent='游녬';
          crownIA.classList.add('visible');
        }
      }

      function evaluateBoard(state) {
        if (checkThree(AI, state)) return -100;
        if (checkThree(HUMAN, state)) return 100;

        let score = 0;
        for (const line of WINS) {
          const vals = line.map(i => state[i]);
          const aiCount = vals.filter(v => v === AI).length;
          const humanCount = vals.filter(v => v === HUMAN).length;
          const emptyCount = vals.filter(v => v === null).length;

          if (aiCount === 2 && emptyCount === 1) score -= 10;
          if (aiCount === 1 && emptyCount === 2) score -= 2;

          if (humanCount === 2 && emptyCount === 1) score += 10;
          if (humanCount === 1 && emptyCount === 2) score += 2;
        }
        return score;
      }

      function minimax(state, depth, alpha, beta, isMaximizing) {
        if (checkThree(AI, state)) return -100 + depth;
        if (checkThree(HUMAN, state)) return 100 - depth;
        if (state.every(x => x !== null) || depth >= 4) {
          return evaluateBoard(state);
        }

        if (isMaximizing) {
          let best = -Infinity;
          for (let i = 0; i < SIZE*SIZE; i++) {
            if (state[i] === null) {
              state[i] = AI;
              const score = minimax(state, depth + 1, alpha, beta, false);
              state[i] = null;
              best = Math.max(best, score);
              alpha = Math.max(alpha, best);
              if (beta <= alpha) break;
            }
          }
          return best;
        } else {
          let best = Infinity;
          for (let i = 0; i < SIZE*SIZE; i++) {
            if (state[i] === null) {
              state[i] = HUMAN;
              const score = minimax(state, depth + 1, alpha, beta, true);
              state[i] = null;
              best = Math.min(best, score);
              beta = Math.min(beta, best);
              if (beta <= alpha) break;
            }
          }
          return best;
        }
      }

      function aiMove(){
        if(gameOver || currentPlayer!==AI) return;

        let bestScore=-Infinity, bestMove=null;
        for(let i=0;i<SIZE*SIZE;i++){
          if(board[i]===null){
            board[i]=AI;
            if(!checkThree(AI)){
              let score=minimax(board,0,-Infinity,Infinity,false);
              if(score>bestScore){ bestScore=score; bestMove=i; }
            }
            board[i]=null;
          }
        }
        if(bestMove!==null){
          placePiece(bestMove,AI);
        } else {
          const fallback=board.findIndex(x=>x===null);
          if(fallback!==-1) placePiece(fallback,AI);
        }
      }

      resetBtn.addEventListener('click', ()=>init());

      init();
    })();
  </script>
</body>
</html>
